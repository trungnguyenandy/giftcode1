<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- Phần head giữ nguyên như trước -->
    <!-- ... -->
</head>
<body>
    <!-- Phần HTML giữ nguyên -->
    <!-- ... -->

    <script>
        // Biến lưu trữ thông tin tài khoản hiện tại
        let currentAccount = null;
        let isProcessing = false;
        
        // ========== PHẦN GIFT CODE (BẢN GỐC + BỔ SUNG CHO iOS) ==========
        async function pasteAndSubmitGift() {
            if (isProcessing) return;
            
            const giftCodeInput = document.getElementById('giftCode');
            const messageDiv = document.getElementById('message');
            const errorDiv = document.getElementById('error');
            const loadingDiv = document.getElementById('giftLoading');
            
            // Reset trạng thái
            messageDiv.textContent = '';
            errorDiv.textContent = '';
            messageDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            
            isProcessing = true;
            try {
                // Hiển thị ô input nếu là iOS
                if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    giftCodeInput.style.display = 'block';
                    giftCodeInput.focus();
                    throw new Error('Trên iPhone/iPad, vui lòng nhấn giữ vào ô và chọn "Dán" sau đó nhấn nút Gửi');
                }
                
                // Thử đọc clipboard (chỉ hoạt động trên các trình duyệt không phải iOS)
                const text = await navigator.clipboard.readText();
                const giftCode = text.trim();
                
                if (!giftCode) {
                    throw new Error('Clipboard không có nội dung');
                }
                
                giftCodeInput.value = giftCode;
                await submitGiftCode(giftCode);
                
                messageDiv.textContent = 'Đã dán và gửi gift code thành công!';
                messageDiv.style.display = 'block';
                giftCodeInput.value = '';
            } catch (err) {
                console.error('Lỗi:', err);
                errorDiv.textContent = err.message || 'Lỗi khi dán và gửi gift code';
                errorDiv.style.display = 'block';
                
                // Giữ ô input hiển thị để người dùng có thể nhập thủ công
                giftCodeInput.style.display = 'block';
                giftCodeInput.focus();
            } finally {
                loadingDiv.style.display = 'none';
                isProcessing = false;
            }
        }
        
        async function submitGiftCode(giftCode) {
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbz0QaWU57qAN7Tkoi0qQ8FdwU3vBWZF814YDjZG_YQ_Tfc6v_AM66LOok7FYU4m6Yh4jQ/exec';
            
            await fetch(scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({code: giftCode}),
            });
        }
        
        // Sự kiện nhấn Enter trong ô input
        document.getElementById('giftCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const giftCode = this.value.trim();
                if (giftCode) {
                    submitGiftCode(giftCode)
                        .then(() => {
                            document.getElementById('message').textContent = 'Đã gửi gift code thành công!';
                            document.getElementById('message').style.display = 'block';
                            this.value = '';
                        })
                        .catch(err => {
                            document.getElementById('error').textContent = 'Lỗi khi gửi gift code';
                            document.getElementById('error').style.display = 'block';
                        });
                }
            }
        });

        // Thêm nút "Chỉ Gửi" dành riêng cho iOS
        function addIOSSubmitButton() {
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                const container = document.querySelector('.container .input-group');
                const submitBtn = document.createElement('button');
                submitBtn.innerHTML = '<span>➡️</span> Chỉ Gửi';
                submitBtn.style.marginLeft = '10px';
                submitBtn.style.backgroundColor = '#fbbc05';
                submitBtn.onclick = function() {
                    const giftCode = document.getElementById('giftCode').value.trim();
                    if (giftCode) {
                        submitGiftCode(giftCode)
                            .then(() => {
                                document.getElementById('message').textContent = 'Đã gửi gift code thành công!';
                                document.getElementById('message').style.display = 'block';
                                document.getElementById('giftCode').value = '';
                            })
                            .catch(err => {
                                document.getElementById('error').textContent = 'Lỗi khi gửi gift code';
                                document.getElementById('error').style.display = 'block';
                            });
                    } else {
                        document.getElementById('error').textContent = 'Vui lòng nhập mã gift trước khi gửi';
                        document.getElementById('error').style.display = 'block';
                    }
                };
                container.appendChild(submitBtn);
            }
        }

        // Gọi hàm thêm nút khi trang tải xong
        window.addEventListener('DOMContentLoaded', addIOSSubmitButton);
        
        // ========== CÁC PHẦN KHÁC GIỮ NGUYÊN ==========
        // ... (giữ nguyên tất cả các phần code khác)
    </script>
</body>
</html>
